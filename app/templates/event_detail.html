{% extends "base.html" %}
{% block content %}
<section class="panel">
  {% if not event %}
    <h2>Event Not Found</h2>
  {% else %}
    <div class="panel-header">
      <h2>Event #{{ event.id }}</h2>
      <span class="panel-sub">
        TCA {{ event.tca }}
        ·
        {% if time_to_tca_hours is not none %}
          {% if time_to_tca_hours >= 0 %}
            in {{ "%.1f"|format(time_to_tca_hours) }}h
          {% else %}
            {{ "%.1f"|format(-time_to_tca_hours) }}h ago
          {% endif %}
        {% endif %}
      </span>
    </div>
    <div class="grid">
      <div class="card">
        <h3>Conjunction</h3>
        <p>Satellite {{ event.satellite_id }} vs {{ space_object.name if space_object else 'Object' }}</p>
        <p>Type: {{ space_object.object_type if space_object else '-' }}</p>
        <p>Status: <span class="pill {{ event.status }}">{{ event.status }}</span></p>
        <p><a class="secondary" href="/events/{{ event.id }}/report">Download PDF Report</a></p>
        <p>Miss distance: {{ "%.3f"|format(event.miss_distance) }} km</p>
        <p>Relative velocity: {{ "%.3f"|format(event.relative_velocity) }} km/s</p>
        <p>Tier: <span class="pill {{ event.risk_tier }}">{{ event.risk_tier }}</span></p>
        <p>Confidence: <span class="pill {{ event.confidence_label|lower }}">{{ event.confidence_label }}</span></p>
        {% if cdm_badge %}
          <p class="panel-sub">
            CDM attached (#{{ cdm_badge["id"] }}) · {{ cdm_badge["originator"] or "unknown" }}
            {% if cdm_badge["creation_date"] %} · created {{ cdm_badge["creation_date"] }}{% endif %}
          </p>
        {% endif %}
        {% if geometry %}
          {% if geometry.r_rel_rtn_km and geometry.v_rel_rtn_km_s %}
            <p class="panel-sub">Geometry @TCA (RTN projection)</p>
            <p>r_rel RTN (km): [{{ "%.3f"|format(geometry.r_rel_rtn_km[0]) }}, {{ "%.3f"|format(geometry.r_rel_rtn_km[1]) }}, {{ "%.3f"|format(geometry.r_rel_rtn_km[2]) }}]</p>
            <p>v_rel RTN (km/s): [{{ "%.3f"|format(geometry.v_rel_rtn_km_s[0]) }}, {{ "%.3f"|format(geometry.v_rel_rtn_km_s[1]) }}, {{ "%.3f"|format(geometry.v_rel_rtn_km_s[2]) }}]</p>
          {% else %}
            <p class="panel-sub">Geometry @TCA (RTN projection not available)</p>
          {% endif %}
        {% endif %}
        <form class="form compact" method="post" action="/events-ui/{{ event.id }}/status">
          <div class="form-row">
            <label>Update Status</label>
            <select name="status">
              <option value="open" {% if event.status == 'open' %}selected{% endif %}>open</option>
              <option value="in_review" {% if event.status == 'in_review' %}selected{% endif %}>in_review</option>
              <option value="closed" {% if event.status == 'closed' %}selected{% endif %}>closed</option>
            </select>
          </div>
          <button class="primary" type="submit">Update</button>
        </form>
      </div>
      <div class="card">
        <h3>Screening Risk</h3>
        <div class="risk-score">Screening index (0-1): {{ "%.2f"|format(event.risk_score) }}</div>
        {% if update %}
          <div class="panel-sub">Top drivers: {{ (update.drivers_json or [])|join(', ') }}</div>
          {% if change %}
            <div class="panel-sub">
              What changed: miss {{ "%.3f"|format(change["delta_miss_km"]) }} km ·
              tier {{ change["tier_from"] }} -> {{ change["tier_to"] }} ·
              conf {{ change["conf_from"] }} -> {{ change["conf_to"] }}
            </div>
          {% endif %}
          {% if update.details_json and update.details_json.components %}
            <details class="details">
              <summary>Why this tier?</summary>
              <ul class="risk-list">
                {% for key, value in update.details_json.components.items() %}
                  <li>{{ key }}: {{ "%.3f"|format(value) }}</li>
                {% endfor %}
              </ul>
            </details>
          {% endif %}
        {% else %}
          <p class="panel-sub">No update details available.</p>
        {% endif %}
      </div>
      <div class="card">
        <h3>Decision</h3>
        {% if decision %}
          <p>Action: {{ decision.action }}</p>
          <p>Approved by: {{ decision.approved_by }}</p>
          <p>Primary driver: {{ decision.decision_driver or '-' }}</p>
          <p>Assumptions: {{ decision.assumption_notes or '-' }}</p>
          <p>Override reason: {{ decision.override_reason or '-' }}</p>
        {% else %}
          <p>No decision recorded yet.</p>
        {% endif %}
      </div>
      <div class="card">
        <h3>Runbook</h3>
        {% if runbook %}
          <p class="panel-sub">{{ runbook.template_name }}</p>
          <ol class="runbook">
            {% for step in runbook.steps_json %}
              <li>{{ step }}</li>
            {% endfor %}
          </ol>
        {% else %}
          <p>No runbook available.</p>
        {% endif %}
      </div>
      <div class="card">
        <h3>Log Decision</h3>
        <form class="form compact" method="post" action="/events-ui/{{ event.id }}/decide">
          <div class="form-row">
            <label>Action</label>
            <select name="action">
              <option value="do_nothing">do_nothing</option>
              <option value="maneuver">maneuver</option>
              <option value="monitor">monitor</option>
            </select>
          </div>
          <div class="form-row">
            <label>Approved By</label>
            <input type="text" name="approved_by" placeholder="ops@example.com" required />
          </div>
          <div class="form-row">
            <label>Primary Risk Driver</label>
            <input type="text" name="decision_driver" placeholder="min_separation" />
          </div>
          <div class="form-row">
            <label>Assumptions</label>
            <textarea name="assumption_notes" rows="2"></textarea>
          </div>
          <div class="form-row">
            <label>Override Reason (if any)</label>
            <textarea name="override_reason" rows="2"></textarea>
          </div>
          <div class="form-row">
            <label>Decision Checklist</label>
            <div class="checkboxes">
              <label><input type="checkbox" name="checklist" value="latest_ephemeris" /> Latest ephemeris verified</label>
              <label><input type="checkbox" name="checklist" value="delta_v_checked" /> Delta‑V checked</label>
              <label><input type="checkbox" name="checklist" value="coordination_done" /> Coordination completed</label>
            </div>
          </div>
          <div class="form-row">
            <label>Rationale</label>
            <textarea name="rationale_text" rows="3"></textarea>
          </div>
          <button class="primary" type="submit">Save Decision</button>
        </form>
      </div>
    </div>
    <div class="panel-subsection">
      <h3>Evolution</h3>
      <div class="table">
        <div class="table-row header">
          <span>Computed</span>
          <span>Miss (km)</span>
          <span>Tier</span>
          <span>Conf</span>
        </div>
        {% for upd in updates %}
        <div class="table-row">
          <span class="mono">{{ upd.computed_at }}</span>
          <span>{{ "%.3f"|format(upd.miss_distance_km) }}</span>
          <span class="pill {{ upd.risk_tier }}">{{ upd.risk_tier }}</span>
          <span class="pill {{ upd.confidence_label|lower }}">{{ upd.confidence_label }}</span>
        </div>
        {% else %}
        <div class="table-row empty">No history yet.</div>
        {% endfor %}
      </div>
    </div>

    {% if update and update.id %}
    <div class="panel-subsection">
      <h3>Visuals</h3>
      <div class="grid">
        <div class="card">
          <h4>Miss Distance vs Time</h4>
          <canvas id="missDistanceChart" height="160"></canvas>
        </div>
        <div class="card">
          <h4>RTN Relative Motion (R vs T)</h4>
          {% if not update.r_rel_rtn_km %}
            <p class="panel-sub">RTN plot is available for TLE screening updates.</p>
          {% endif %}
          <canvas id="rtnRTChart" height="160"></canvas>
        </div>
        <div class="card">
          <h4>RTN Normal (N vs time)</h4>
          {% if not update.r_rel_rtn_km %}
            <p class="panel-sub">RTN plot is available for TLE screening updates.</p>
          {% endif %}
          <canvas id="rtnNChart" height="160"></canvas>
        </div>
        <div class="card">
          <h4>Evolution (Miss @TCA)</h4>
          <canvas id="evolutionChart" height="160"></canvas>
        </div>
      </div>
    </div>

    <script src="/static/vendor/chart.umd.min.js"></script>
    <script src="/static/event-charts.js"></script>
    <script>
      window.renderEventCharts({{ event.id }}, {{ update.id }});
    </script>
    {% endif %}
  {% endif %}
</section>
{% endblock %}
