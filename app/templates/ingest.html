{% extends "base.html" %}
{% block content %}
<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Add Orbit State</h2>
      <span class="panel-sub">For best results: operator ephemerides or high-confidence tracking.</span>
    </div>
  </div>

  <form class="form" method="post" action="/ingest-ui">
    <div class="form-row">
      <label>Satellite</label>
      {% if satellites|length %}
        <select name="satellite_id" required>
          {% for sat in satellites %}
          <option value="{{ sat.id }}">#{{ sat.id }} — {{ sat.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        <div class="empty-state">Add a satellite first: <a href="/satellites-ui">Satellites</a></div>
      {% endif %}
    </div>
    <div class="form-row">
      <label>Epoch (UTC ISO)</label>
      <input type="text" name="epoch" placeholder="2026-02-04T00:00:00Z" required />
    </div>
    <div class="form-row">
      <label>State Vector (x,y,z,vx,vy,vz)</label>
      <input type="text" name="state_vector" placeholder="7000,0,0,0,7.5,0" required />
    </div>
    <div class="form-row">
      <label>Confidence (0-1)</label>
      <input type="number" name="confidence" step="0.01" min="0" max="1" value="0.6" />
    </div>
    <div class="form-row">
      <label>Source Name</label>
      <input type="text" name="source_name" value="public-tle" required />
    </div>
    <div class="form-row">
      <label>Source Type</label>
      <select name="source_type">
        <option value="public">public</option>
        <option value="commercial">commercial</option>
        <option value="ephemeris">ephemeris</option>
      </select>
    </div>
    <button class="primary" type="submit" {% if not satellites|length %}disabled{% endif %}>Add Orbit State</button>
  </form>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Attach CCSDS CDM (KVN)</h2>
      <span class="panel-sub">Paste or upload a CDM KVN text message to update an existing event.</span>
    </div>
  </div>
  <div class="notice">
    A CDM is a tracking message used for assessment, not a collision warning.
  </div>

  <form id="cdmForm" class="form" onsubmit="return false;">
    <div class="form-row">
      <label>Inbox Mode</label>
      <label class="panel-sub">
        <input id="cdmInboxMode" type="checkbox" />
        Auto-create/dedupe event (no Event ID required)
      </label>
      <span class="panel-sub">If checked, the server will match OBJECT1/OBJECT2 to your operator satellite and create/update the event timeline.</span>
    </div>
    <div class="form-row">
      <label>Primary Satellite (optional)</label>
      {% if satellites|length %}
        <select id="cdmPrimarySatellite">
          <option value="">Auto-detect from CDM</option>
          {% for sat in satellites %}
            <option value="{{ sat.id }}">#{{ sat.id }} — {{ sat.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        <div class="empty-state">No satellites yet. Add one first in <a href="/satellites-ui">Satellites</a>.</div>
      {% endif %}
      <span class="panel-sub">Use if CDM ordering is ambiguous.</span>
    </div>
    <div class="form-row">
      <label>Event (active)</label>
      {% if events|length %}
        <select id="cdmEventSelect">
          <option value="">Select an event...</option>
          {% for e in events %}
            <option value="{{ e.id }}">#{{ e.id }} — sat {{ e.satellite_id }} vs {{ e.object_name or '-' }} — TCA {{ e.tca }}</option>
          {% endfor %}
        </select>
      {% else %}
        <div class="empty-state">No active events yet. Run screening in <a href="/events-ui">Alerts</a>.</div>
      {% endif %}
    </div>
    <div class="form-row">
      <label>Event ID (manual)</label>
      <input id="cdmEventId" type="number" placeholder="Event ID" />
      <span class="panel-sub">Use if the event is not in the dropdown.</span>
    </div>
    <div class="form-row">
      <label>Override Secondary Match</label>
      <select id="cdmOverrideSecondary">
        <option value="false" selected>false</option>
        <option value="true">true</option>
      </select>
    </div>
    <div class="form-row">
      <label>CDM KVN Text</label>
      <textarea id="cdmKvn" rows="14" placeholder="Paste CCSDS CDM KVN here..."></textarea>
      <span class="panel-sub">Include OBJECT1/OBJECT2 state vectors, REF_FRAME, and MISS_DISTANCE with units.</span>
    </div>
    <div class="form-row">
      <label>Upload CDM File (optional)</label>
      <input id="cdmFile" type="file" accept=".txt,.kvn,.cdm,text/plain" />
    </div>

    <div class="form-actions">
      <button id="cdmExampleBtn" class="secondary" type="button">Fill Example</button>
      <button id="cdmSubmitBtn" class="primary" type="button" {% if not satellites|length %}disabled{% endif %}>Attach CDM</button>
      <span id="cdmStatus" class="panel-sub"></span>
    </div>
  </form>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Quick Actions</h2>
      <span class="panel-sub">Need something to click around?</span>
    </div>
  </div>
  <form method="post" action="/demo/seed">
    <button class="secondary" type="submit">Seed Demo Data</button>
  </form>
</section>

<script>
  const cdmStatus = document.getElementById('cdmStatus');
  const cdmSubmitBtn = document.getElementById('cdmSubmitBtn');
  const cdmExampleBtn = document.getElementById('cdmExampleBtn');
  const cdmEventSelect = document.getElementById('cdmEventSelect');
  const cdmInboxMode = document.getElementById('cdmInboxMode');

  function setCdmStatus(msg, kind = 'info') {
    if (!cdmStatus) return;
    cdmStatus.textContent = msg;
    cdmStatus.dataset.kind = kind;
  }

  function str(id) {
    const el = document.getElementById(id);
    return el ? String(el.value || '').trim() : '';
  }

  function selectedEventId() {
    const manual = str('cdmEventId');
    if (manual) return manual;
    const fromSelect = cdmEventSelect ? String(cdmEventSelect.value || '').trim() : '';
    return fromSelect;
  }

  cdmExampleBtn?.addEventListener('click', () => {
    const tca = new Date(Date.now() + 2 * 3600 * 1000).toISOString();
    const example = [
      'CCSDS_CDM_VERS = 1.0',
      `CREATION_DATE = ${new Date().toISOString()}`,
      'ORIGINATOR = DEMO',
      `TCA = ${tca}`,
      'REF_FRAME = GCRS',
      'MISS_DISTANCE = 20.0 [m]',
      'RELATIVE_SPEED = 10.0 [m/s]',
      'OBJECT = OBJECT1',
      'NORAD_CAT_ID = 10000',
      'OBJECT_NAME = ALPHA',
      'X = 7000.0 [km]',
      'Y = 0.0 [km]',
      'Z = 0.0 [km]',
      'X_DOT = 0.0 [km/s]',
      'Y_DOT = 7.5 [km/s]',
      'Z_DOT = 0.0 [km/s]',
      'OBJECT = OBJECT2',
      'NORAD_CAT_ID = 12345',
      'OBJECT_NAME = CATALOG-DELTA',
      'X = 7000.02 [km]',
      'Y = 0.0 [km]',
      'Z = 0.0 [km]',
      'X_DOT = 0.0 [km/s]',
      'Y_DOT = 7.51 [km/s]',
      'Z_DOT = 0.0 [km/s]',
      'CR_R = 100.0 [m^2]',
      'CT_R = 0.0 [m^2]',
      'CT_T = 100.0 [m^2]',
      'CN_R = 0.0 [m^2]',
      'CN_T = 0.0 [m^2]',
      'CN_N = 100.0 [m^2]',
      '',
    ].join('\\n');
    const kvnEl = document.getElementById('cdmKvn');
    if (kvnEl) kvnEl.value = example;
    setCdmStatus('Example filled. Click Attach CDM to ingest.', 'info');
  });

  cdmSubmitBtn?.addEventListener('click', async () => {
    try {
      setCdmStatus('Submitting…', 'info');
      cdmSubmitBtn.disabled = true;
      const inbox = Boolean(cdmInboxMode && cdmInboxMode.checked);
      const eventId = selectedEventId();
      if (!inbox && !eventId) throw new Error('Select an event, enter an Event ID, or enable Inbox Mode');

      const override = str('cdmOverrideSecondary') === 'true';
      const primarySat = str('cdmPrimarySatellite');
      const kvn = str('cdmKvn');
      const fileEl = document.getElementById('cdmFile');
      const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

      let resp;
      if (file) {
        const form = new FormData();
        form.append('file', file);
        form.append('override_secondary', String(override));
        if (primarySat) form.append('primary_satellite_id', primarySat);
        if (kvn) form.append('kvn', kvn);
        const url = inbox ? '/cdm/inbox' : `/events/${encodeURIComponent(eventId)}/cdm`;
        resp = await fetch(url, { method: 'POST', body: form });
      } else {
        const url = inbox
          ? `/cdm/inbox${primarySat ? `?primary_satellite_id=${encodeURIComponent(primarySat)}` : ''}`
          : `/events/${encodeURIComponent(eventId)}/cdm?override_secondary=${override ? 'true' : 'false'}`;
        resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: kvn,
        });
      }
      if (!resp.ok) {
        let detail = null;
        try {
          const data = await resp.json();
          detail = data && data.detail ? data.detail : data;
        } catch (e) {
          // ignore
        }
        if (detail && detail.errors && Array.isArray(detail.errors)) {
          throw new Error(detail.errors.join(' | '));
        }
        if (typeof detail === 'string') {
          throw new Error(detail);
        }
        const text = await resp.text();
        throw new Error(text || 'Request failed');
      }
      const data = await resp.json();
      const cov = data.covariance_present ? 'covariance: yes' : 'covariance: no';
      setCdmStatus(`Attached. Update #${data.update_id} (${cov}). Redirecting…`, 'ok');
      window.location.href = `/events-ui/${encodeURIComponent(String(data.event_id || eventId))}`;
    } catch (err) {
      setCdmStatus(`Failed: ${err.message || err}`, 'error');
    } finally {
      cdmSubmitBtn.disabled = false;
    }
  });
</script>
{% endblock %}
